# Proto Generation

## Default generation 

By default each model generate the default viewset as proto file. It allow by default to match all the endpoint given by the generics.AsyncModelService or generics.ModelService classes.

For example if we have a model like:

```python
class Something(models.Model):
    uuid = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    start_date = models.DateField()
    rate = models.CharField(max_length=255, null=True, blank=True, verbose_name=_("Rate"))
```

this will generate a proto like:
```proto
syntax = "proto3";

package tutorial.quickstart;

import "google/protobuf/empty.proto";

service SomethingController {
    rpc List(SomethingListRequest) returns (SomethingListResponse) {}
    rpc Create(Something) returns (Something) {}
    rpc Retrieve(SomethingRetrieveRequest) returns (Something) {}
    rpc Update(Something) returns (Something) {}
    rpc Destroy(SomethingDestroyRequest) returns (google.protobuf.Empty) {}
}

message Something {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
}

message SomethingListRequest {
}

message SomethingListResponse {
    repeated Something results = 1;
}

message SomethingRetrieveRequest {
    string uuid = 1;
}

message SomethingDestroyRequest {
    string uuid = 1;
}
```

## Customize proto generation

[See exemple used for test here](https://github.com/socotecio/django-socio-grpc/blob/master/django_socio_grpc/tests/fakeapp/models.py)

It is possible to adapt the proto generation depending of your need. To customize your proto generation you need to override `grpc_messages` and `grpc_methods` attributes of the Meta class of the model:

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {...}
        grpc_methods = {...}
```

This two dictionnary will allow you to customize the messages and the methods generated by the command `generate_proto` by simply reconstruct the file from the data of the dict. To see the data format read the next two sections.

## Customize gRPC Messages

### Format

`grpc_messages` attribute is a dict with the format: `{[MessageName<String>]: FieldNames<Array<String>>}` where:

- MessageName is the name of the message as it appear in the proto file (SomethingListRequest, SomethingListResponse...)
- FieldNames is an array of models field. We use django instrospection to find the correct type to display in the proto file

Example if we want a message named SomethingSmall:

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {"SomethingSmall": ["uuid", "start_date"]}
        grpc_methods = {}
```

This will generate a proto file like:
```proto
syntax = "proto3";

package tutorial.quickstart;

message SomethingSmall {
    string uuid = 1;
    string start_date = 2;
}
```


### Specific FieldName Values

There is two helper to help building message:
- `__all__`: Allow you to use all the fields of the model

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {"SomethingAll": "__all__"}
        grpc_methods = {}
```

This will generate a proto file like:
```proto
syntax = "proto3";

package tutorial.quickstart;

message SomethingSmall {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
}
```

- `__custom__[proto_type]__[field_name]__`: Allow to specify a name not existing in the model and specify its type. You can put everything you want it will be directly transformed into protobuf format without django instropection. Be carefull when you use it to match your serializer and if you use nested messages that the other message it already declared.

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {"SomethingAll": ["uuid", "__custom__int32__counter__", "__custom__repeated string__last_rates__"]}
        grpc_methods = {}
```

This will generate a proto file like:
```proto
syntax = "proto3";

package tutorial.quickstart;

message SomethingSmall {
    string uuid = 1;
    int32 counter = 2;
    repeated string last_rates = 3;
}
```

## Customize gRPC Methods

### Format

`grpc_methods` attribute is a dict with the format `{[MethodName<String>]: { request: Request<Object>, response: Response<Object>}}` where `Request` and `Response` are object like: `{message: MessageName<String>, is_stream: <Boolean>}`

This data are simply used to generate the line of the method specified by MethodName in the grpc controller.
Example:

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_methods = {
            "StreamList": {
                "request": {"is_stream": False, "message": "SomethingListRequest"},
                "response": {"is_stream": True, "message": "SomethingListStreamResponse"},
            },
        }
```

This will generate a proto file like:
```proto
syntax = "proto3";

package tutorial.quickstart;

service ForeignModelController {
    rpc StreamList(SomethingListRequest) returns (stream SomethingListStreamResponse) {}
}
```

This will crash you have not SomethingListRequest and SomethingListStreamResponse defined in the messages of the proto file.
See the [default generated message and methods](#using-default-methods-to-simplify-overwriting)


## Using default methods to simplify overwriting

As seen in the first part of this page we have some default generation. But at soon as you overwrite `grpc_methods` or `grpc_messages` you loose all the default generation. 
Often you only want to add a custom field or doesn't want to rewrite the all things.

For that you can use the mixins methods `get_default_message` and `get_default_method` like:

```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {
            **CreateModelMixin.get_default_message("Something"),
            **ListModelMixin.get_default_message("Something"),
            "SomethingRetrieveRequestCustom": ["name"],
            "SomethingRetrieveResponseCustom": ["uuid"],
        }
        grpc_methods = {
            **ListModelMixin.get_default_method("Something"),
            "Retrieve": {
                "request": {
                    "is_stream": False,
                    "message": "SomethingRetrieveRequestCustom",
                },
                "response": {
                    "is_stream": False,
                    "message": "SomethingRetrieveResponseCustom",
                },
            },
        }
```

this will generate something like:

```proto
syntax = "proto3";

package tutorial.quickstart;

import "google/protobuf/empty.proto";

service SomethingController {
    rpc List(SomethingListRequest) returns (SomethingListResponse) {}
    rpc Retrieve(SomethingRetrieveRequest) returns (Something) {}
}

message Something {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
}

message SomethingListRequest {
}

message SomethingListResponse {
    repeated Something results = 1;
}

message SomethingRetrieveRequestCustom {
    string name = 1;
}

message SomethingRetrieveResponseCustom {
    string uuid = 1;
}
```

`get_default_message` and `get_default_method` exist for all the mixins: CreateModelMixin, ListModelMixin, StreamModelMixin, RetrieveModelMixin, UpdateModelMixin, PartialUpdateModelMixin, DestroyModelMixin. Same for the async model that just inherit from the sync models.

You can also use `mixins.get_default_grpc_methods` and `mixins.get_default_grpc_messages` to simulate all the defautl configuration and overwrite it after:


```python
class Something(models.Model):
    ...

    class Meta:
        grpc_messages = {
            **get_default_grpc_messages("Something"),
            "Something": ["uuid", "start_date", "rate", "__custom__string__new_field__"]
        }

        grpc_methods = {
            **get_default_grpc_methods("Something"),
        }
```

this will generate something like:

```proto
syntax = "proto3";

package tutorial.quickstart;

import "google/protobuf/empty.proto";

service SomethingController {
    rpc List(SomethingListRequest) returns (SomethingListResponse) {}
    rpc Create(Something) returns (Something) {}
    rpc Retrieve(SomethingRetrieveRequest) returns (Something) {}
    rpc Update(Something) returns (Something) {}
    rpc Destroy(SomethingDestroyRequest) returns (google.protobuf.Empty) {}
}

message Something {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
    string new_filed = 4;
}

message SomethingListRequest {
}

message SomethingListResponse {
    repeated Something results = 1;
}

message SomethingRetrieveRequest {
    string uuid = 1;
}

message SomethingDestroyRequest {
    string uuid = 1;
}
```